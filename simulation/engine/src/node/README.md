This folder defines additional modules for defining the EnGINE network.
[EngineLink.ned](EngineLink.ned) defines channels that realize the links between testbed nodes. The channel EngineLink extends the channel EthernetLink which is included in the INET framework. EthernetLink defines a length parameter that will then be used to calculate the delay paramter for DatarateChannel. Enginelink sets the length parameter to 1.5m for all links. The channels EngineLink1_0G, EngineLink2_5G, and EngineLink10_0G extend EngineLink and set the datarate parameter to the respective datarate contained in their names.
[EngineNode.ned](EngineNode.ned) defines the compound module EngineNode, which realizes individual testbed nodes. EngineNode defines the prameter type that specifies the type of a node, i.e. "ZGWI210" (zonal gateways with I210 interfaces), or "VCC" (vehicle control computer). The parameter numEthInterfaces is based on the type and gives the number of interfaces the EngineNode has for connections with other nodes. The parameter numFlows defauts to 0 and determines the number of EnGINE flows for which this node is an endpoint.
EngineNode has numEthInterfaces inout ethernet gates for connections with the other testbed nodes. 
EngineNode has the submodule device, of inner type EngineDevice, and switch, of the respect√≠ve inner type EngineSwitch* matching the type parameter.
EngineNode defines connections between these two submodules. The default interfaces of the switch are connected to the (external) interfaces of this module. Additional numFlows interfaces are created and connected between switch and device, using the channel type None.
EngineNode defines the inner type EngineDevice, which extends INET framework's TsnDevice and sets parameters to fixed values or useful defaults. TsnDevice extends StandardHost with TSN functionality by defining an optional gptp submodule for PTP and including respective default types for submodules based on additional boolean parameters. The parameter hasOutgoingStreams, defined in TsnDevice, is set to true for having a bridging and an ieee8021q submodule that facilitate IEEE802.1q protocol encapsulation and decapsulation. It enables streamCoder and streamIdentifier to be usable for mapping packets to streams and eventually apply pcp values and vlan tags. The submodule parameters bridging.streamIdentifier.identifier.mapping and bridging.streamCoder.encoder.mapping are then set to default values to apply a default pcp of 0 and vlan tag of 2, as used in EnGINE. The submodule parameters eth[x].bitrate are set to infinity for all interfaces to achieve a infinity bitrate for connections between device and switch, to make these links virtually negligible for the overall delay. All crcMode and fcsMode submodule parameters are set to "computed" to enable pcap recording via modules of type PcapRecorder. ipv4.arp.typename is set to "GlobalArp" to disable use of ARP, which would interfere with the implementation of flows. Instead automatically configured address resolution is used. tcp.advertisedWindow is set to 65535 and tcp.mss is set to 1460, to better match the behaviour of the linux stack.
The inner type EngineSwitch serves as base class for various other modules defining the actual interface properites of testbed nodes in use. EngineSwitch extends INET framework's TsnSwitch and sets parameters to fixed values or useful defaults. TsnSwitch extends EthernetSwitch with TSN functionality by including respective default types for submodules based on additional boolean parameters. The parameter hasEgressTrafficShaping is set to true to use Ieee8021qTimeAwareShaper type for the macLayer.queue submodule, which enables configuration of TSN queues. The parameter hasGptp is set to true to enable the gptp and local clock submodules for time synchronization via PTP. The submodule parmeters gptp.gptpNodeType and gptp.slavePort are set to default values to avoid errors. The submodule parameters eth[x].bitrate are then set to infinity for all interfaces to achieve a infinity bitrate for connections between device and switch, to make these links virtually negligible for the overall delay. The submodule typenames eth[x].macLayer.typename are set to the inner type EthernetMacLayerWithPcapRecorder for all interfaces to facilitate pcap recording for realizing EnGINE's tcpdump service. To mirror EnGINE's default qdisc behavior, parameters of all interfaces' submodules eth[x].macLayer.queue are set to fixed values or defaults. The packetCapacity parameter is set to 10240. For all queues, the parameter transmissionGate[x].typename is set to disable the default use of periodic gates and mimic use of EnGINE's default mqprio qdisc. The submodule pararameter transmissionGate[x].clockModule are set to "^.^.^.^.clock", to synchronize the gates with EnGINE switch's clock synchronized via PTP. classifier.defaultGateIndex and classifier.mapping are set to default values to realize EnGINE's default priority to queue mapping. All submodule parameters.crcMode and fcsMode are set to "computed" to enable pcap recording via modules of type PcapRecorder. The submodule parameter bridging.streamCoder.typename is set "StreamCoderLayer" to enable the respective submodule for IEEE802.1q protocol encapsulation and decapsulation. The parameters bridging.streamCoder.decoder.mapping and bridging.streamCoder.encoder.mapping are then set to a trivial mapping, for keeping the respective tags and values of the packets entering the switch.
The inner types EngineSwitchI210 and EngineSwitchLarge extend EngineSwitch and set a respective number of ethernet gates and, for the ethernet interfaces, the bitrate parmeter as well as the macLayer.queue.numTrafficClasses submodule parameter, to match the properties of the actual testbed nodes in used.
The inner type None defines a channel for connections between the switch and device submodules. It sets bit and packet error rates to 0, delay to 0s and datarate to 0bps, i.e. infinity, to realize link with virtually no impact.
The inner type EthernetMacLayerWithPcapRecorder extends INET framework's EthernetMacLayer with an additional submodule array pcapRecorder of implicit type PcapRecorder, and additional parameters. The additional parameters include the boolean recordPcap and integer numPcapRecorders, to mimic the use of PcapRecorder arrays by other modules. The implicit PcapRecorder type sets parameters to fixed values or useful defaults, to be usable for realizing EnGINE's tcpdump service.

# Configuration

EngineNode has the parameter type, which determines the number of interfaces and their properties for a testbed node. This parameter can be used when defining a network with nodes of different types. The parameter numFlows should be set per simulation per experiment for each node to specify the experiment specific number of flows for which the respectice node is endpoint, based on the actual flow configuration.
The respective device and switch submodules for a node can be directly referenced. The different number of interfaces based on the type and numFlows parameters have to be minded. While the device submodule can be used for realizing services generating or receiving traffic, which depend on a certain flow being used, the switch submodule can be used for realizing monitoring services and the configuration of queue configuration on its external interfaces. The device submodule can be used for setting up the flow specific addresses for which a node is endpoint, while the switch should implement forwarding rules based on the flow specific endpoint MAC addresses.
The eth[x].address submodule parameter can be used for setting interface specifc MAC addresses. IP addresses can be implicitly set via the configurator.config submodule parameter of the containing network. The internal connections between device and switch virtually have no influence on the actual traffic being used, and their sole purpose is to intall flow specifc IP and MAC addresses at the device. The external interfaces (beginning with index 1) of the switch mirror the interfaces of the actual testbed nodes and their respective macLayer submodules facilitate to install queue configurations. The submodule parameter macTable.addressTable can be used for setting up forwarding rules based on destination MAC addresses.
For the device, the submodule parameters bridging.streamIdentifier.identifier.mapping and bridging.streamCoder.encoder.mapping can be used to map service specific traffic to pcp values, if needed. A respective packet filter should be chosen to match traffic for relevant services only. When redefining these parameters, the entries used as defaults should be included to have the correct default priority and vlan id. The submodule array app[] and the corresponding parameter numApps can be used for setting up modules for sending or receiving traffic. 
For the switch, the submodule gptp can be used for setting PTP specific parameters. gptp.gptpNodeType and gptp.slavePort can be used to set the hierarchy of nodes and interfaces. The submodule parameter clock.oscillator.driftRate can be used to set behaviour of the node's clock. eth[x].macLayer.recordPcap and eth[x].macLayer.numPcapRecorders can be used to enable a single submodule of type PcapRecorder or any other number. The individual PcapRecorders in the pcapRecorder Array can then be used to realize the tcpdump services by setting the snaplen parameter to the relevant value and optionally setting a different filename via the pcapFile paramter. For queue configuration, the submodules eth[x].macLayer.queue have to be modified. The default is a mqprio like setup. To realize a taprio qdisc, PeriodicGate submodules can be set up for each child queue by setting the transmissionGate[y].typename parameter. The boolean parameter transmissionGate[y].initiallyOpen indicates whether the gate should be open or closed at the beginning of its schedule and the parameter transmissionGate[y].offset indicates the offset where it should start in the schedule. The parameter transmissionGate[y].duration lists the periodic schedule of durations for the gate states. The submodules transmissionSelectionAlgorithm[y] and their type parameters transmissionSelectionAlgorithm[y].typename can be set to Ieee8021qCreditBasedShaper to realize CBS. The submodule parameters can idleSlope, sendSlope, minCredit and maxInterferenceSize can then be used to apply appropriate settings. The submodule parameter classifier.mapping and classifier.defaultGateIndex can be used to set the configuration specific mapping of priorities to queues. Submodules queue[y] can be used for statistics recording for each queue.
